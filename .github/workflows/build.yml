name: Deploy to App Service

on:
  workflow_run:
    workflows: ["Build and Push Docker Image to ACR"]  # Match your build.yml name
    types: [completed]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Get App Service and ACR details dynamically
      run: |
        # Get App Service details (assuming you have one App Service in resource group)
        APP_NAME=$(az webapp list --resource-group your-resource-group --query "[0].name" -o tsv)
        ACR_LOGIN_SERVER=$(az acr list --resource-group your-resource-group --query "[0].loginServer" -o tsv)
        
        echo "APP_NAME=$APP_NAME" >> $GITHUB_ENV
        echo "ACR_LOGIN_SERVER=$ACR_LOGIN_SERVER" >> $GITHUB_ENV
        
        echo "Deploying to App Service: $APP_NAME"
        echo "Using image from: $ACR_LOGIN_SERVER"
    
    - name: Deploy to App Service
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.APP_NAME }}
        images: ${{ env.ACR_LOGIN_SERVER }}/myapp:latest
